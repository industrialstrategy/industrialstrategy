<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Industrial Strategy Tracker</title>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <header>
      <h1>Industrial Strategy Tracker</h1>
      <p>Independent feed of government and industry updates filtered by your keywords.</p>
    </header>

    <section class="search">
      <input id="q" type="search" placeholder="Search titles and summaries..." />
      <button id="clear">Clear</button>
      <div id="meta"></div>
    </section>

    <main id="results"></main>

    <footer>
      <p>Data generated by <code>scraper.py</code>. Edit keywords & sources in <code>config.json</code>. This page loads <code>data/news.json</code> produced by your last run.</p>
    </footer>

    <script>
      async function loadData() {
        const res = await fetch("../data/news.json?ts=" + Date.now());
        if (!res.ok) {
          document.getElementById("results").innerHTML = "<p>Run <code>python scraper.py</code> to generate data/news.json</p>";
          return { items: [] };
        }
        return res.json();
      }

      function matchesQuery(item, q) {
        if (!q) return true;
        const t = (item.title + " " + item.summary).toLowerCase();
        return t.includes(q.toLowerCase());
      }

      function render(items, q, meta) {
        const root = document.getElementById("results");
        if (!items.length) {
          root.innerHTML = "<p>No items found.</p>";
          return;
        }
        root.innerHTML = items.map(it => `
          <article class="card">
            <h3><a href="${it.link}" target="_blank" rel="noopener">${it.title}</a></h3>
            <p class="meta">
              ${it.published ? new Date(it.published).toLocaleString() : ""}
              ${it.source ? " • " + new URL(it.source).hostname : ""}
            </p>
            <p>${(it.summary || "").slice(0, 280)}${(it.summary || "").length>280 ? "…" : ""}</p>
            ${it.matched && it.matched.length ? `<p class="tags">${it.matched.map(m => `<span>${m}</span>`).join(" ")}</p>` : ""}
          </article>
        `).join("");
        document.getElementById("meta").textContent = meta;
      }

      (async function init(){
        const data = await loadData();
        const input = document.getElementById("q");
        const clear = document.getElementById("clear");

        let q = "";
        function refresh(){
          const filtered = (data.items || []).filter(it => matchesQuery(it, q));
          const meta = `${filtered.length} of ${data.count || (data.items||[]).length} items • generated ${data.generated_at || ""}`;
          render(filtered, q, meta);
        }

        input.addEventListener("input", (e) => { q = e.target.value; refresh(); });
        clear.addEventListener("click", () => { q = ""; input.value = ""; refresh(); });

        refresh();
      })();
    </script>
  </body>
</html>
